{% extends "base.html" %}
{% load humanize %}
{% block title %}Bosh sahifa{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 ">
  <h4 class="mb-0 d-flex align-items-center">
    <i class="fa-solid fa-square-poll-horizontal me-2 text-danger"></i> Kirim–Chiqim
    <span class="badge bg-info ms-3">
      Omborda: {{ total_left_kg|floatformat:0|intcomma }} kg ({{ total_left_ton|floatformat:3 }} tonna)
    </span>
  </h4>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createIncomeSaleModal">
    <i class="fa-solid fa-plus"></i> Kirim/Sotuv
  </button>
</div>
{% if messages %}
  {% for m in messages %}
    <div class="alert alert-info d-flex align-items-center py-2 mb-3">
      <i class="fa-solid fa-circle-info me-2"></i>
      <div>{{ m }}</div>
    </div>
  {% endfor %}
{% endif %}


<!-- Filters -->
<form method="get" class="row g-2 mb-3">
  <div class="col-md-3">
    <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
  </div>
  <div class="col-md-3">
    <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
  </div>
  <div class="col-md-4">
    <input type="text" class="form-control" name="q" placeholder="Markasi yoki nomi" value="{{ q }}">
  </div>
  <div class="col-md-2">
    <button class="btn btn-outline-primary w-100"><i class="fa-solid fa-magnifying-glass"></i> Qidirish</button>
  </div>
</form>

<!-- IncomeSale table -->
<div class="border rounded">
  <div class="table-responsive tiny-scrollbar" style="max-height:60vh; overflow:auto;">
    <table class="table table-bordered border-secondary-emhasis table-hover table-striped align-middle mb-0">
      <thead class=" text-center table-primary text-uppercase text-nowrap" style="position: sticky; top:0; z-index:1;">
        <tr>
          <th >№</th>
          <th scope="col">Markasi</th>
          <th scope="col">Nomi</th>
          <th scope="col">Harakat</th>
          
          
          <th scope="col">Kirim/Sotuv Sanasi</th>
          <th scope="col">Kirim Narxi</th>
          <th scope="col">Sotuv Narxi</th>

          <th scope="col">Miqdor</th>
          <th scope="col">Birlik</th>
          
          <th scope="col">Jami Kirim Narxi</th>
          <th scope="col">Jami Sotuv Narxi</th>

          <th scope="col">Qayerdan</th>
          <th scope="col">Qayerga</th>
          <th scope="col">Bajardi</th>
          <th scope="col">Bajargan Vaqti</th>
          <th scope="col">O'zgartirildi</th>
          <th scope="col">Harakatlar</th>
        </tr>
      </thead>
      <tbody class="text-center center-align text-nowrap" style="font-size:15px;">
        
        {% for row in page_obj %}
        <tr>
          <td class="text-primary-emphasis ">{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td class="text-primary-emphasis">{{ row.meat.meat_code }}</td>
          <td class="text-primary-emphasis">{{ row.meat.meat_name }} </td>
          <td class="text-primary-emphasis">{{ row.action_type }}</td>
          
          <td class="text-primary-emphasis">{{ row.operation_date|date:"Y-m-d" }}</td>

          <td class="text-primary-emphasis">{{ row.in_price|intcomma }}</td>
          <td class="text-primary-emphasis">{{ row.sell_price|intcomma }}</td>

          <td class="text-primary-emphasis">{{ row.quantity|intcomma }}</td>
          <td class="text-success">{{ row.quantity_unit }}</td>
          
          <td class="text-primary-emphasis">{{ row.total_in_price|intcomma }}</td>
          <td class="text-primary-emphasis">{{ row.total_sell_price|intcomma }}</td>
          <td class="text-primary-emphasis">{{ row.from_where}}</td>
          <td class="text-primary-emphasis">{{ row.to_where}}</td>
          <td class="text-primary-emphasis">{{ row.create_user.username}}</td>
          <td class="text-primary-emphasi">{{ row.created_at|date:"Y-m-d H:i" }}</td>
          <td class="text-primary-emphasis">{{ row.updated_at|date:"Y-m-d H:i" }}</td>
          <td>
            {% if row.create_user == request.user or request.user.is_superuser %}
              <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editIncomeSaleModal{{ row.id }}">
                <i class="fa-regular fa-pen-to-square"></i>
              </button>
            {% else %}
              <span class="text-muted small">—</span>
            {% endif %}
          </td>

        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center text-muted">Hech qanday yozuv yo‘q</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
<nav class="mt-3">
  <ul class="pagination">
    {% if page_obj.has_previous %}
    <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Oldingi</a></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span></li>
    {% if page_obj.has_next %}
    <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Keyingi</a></li>
    {% endif %}
  </ul>
</nav>

<!-- Create IncomeSale Modal -->
<div class="modal fade" id="createIncomeSaleModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-plus me-2"></i>Yangi Kirim/Sotuv</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'income_sale_create' %}">
        <div class="modal-body">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Mahsulot</label>
            {{ form.meat }}
          </div>
          <div class="mb-3">
            <label class="form-label">Miqdor</label>
            {{ form.quantity }}
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Birlik</label>
              {{ form.quantity_unit }}
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Harakat turi</label>
              {{ form.action_type }}
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Sana</label>
            {{ form.operation_date }}
          </div>
          <div class="mb-3">
            <label class="form-label">Qayerdan</label>
            {{ form.from_where }}
          </div>
          <div class="mb-3">
            <label class="form-label">Qayerga</label>
            {{ form.to_where }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Bekor</button>
          <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Edit modals -->
{% for row in page_obj %}
<div class="modal fade" id="editIncomeSaleModal{{ row.id }}">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa-regular fa-pen-to-square me-2"></i>Kirim/Chiqim Tahrirlash
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'income_sale_update' row.id %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Mahsulot</label>
            <input type="text" class="form-control" value="{{ row.meat }}" readonly disabled>
            <input type="hidden" name="meat" value="{{ row.meat.id }}">
          </div>
          <div class="row">
             <div class="col-md-6 mb-3">
              <label class="form-label">Harakat turi</label>
              <input type="text" class="form-control" value="{{ row.action_type }}" readonly disabled>
              <input type="hidden" name="action_type" value="{{ row.action_type }}">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Miqdor</label>
              <input type="number" step="0.001" name="quantity" class="form-control" value="{{ row.quantity }}">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Birlik</label>
              <input type="text" class="form-control" value="{{ row.quantity_unit }}" readonly disabled>
              <input type="hidden" name="quantity_unit" value="{{ row.quantity_unit }}">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Sana</label>
              <input type="date" name="operation_date" class="form-control"
                     value="{{ row.operation_date|date:'Y-m-d' }}">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Qayerdan</label>
            <input type="text" name="from_where" class="form-control" value="{{ row.from_where }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Qayerga</label>
            <input type="text" name="to_where" class="form-control" value="{{ row.to_where }}">
          </div>

          <!-- faqat ko‘rsatish uchun -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Kirish narxi</label>
              <input type="text" class="form-control" value="{{ row.meat.meat_in_price|floatformat:2 }}" disabled>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Sotish narxi</label>
              <input type="text" class="form-control" value="{{ row.meat.meat_sell_price|floatformat:2 }}" disabled>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Bekor</button>
          <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}


{% endblock %}

